name: ImmortalWRT Compile Check

on:
  workflow_dispatch: # 仅手动触发

env:
  # --- 请在此处填入你存放修改好 DTS 的 ImmortalWRT 仓库信息 ---
  SOURCE_REPO: "guorong697/immortalwrt" # 例如："myusername/immortalwrt-fur602"
  SOURCE_BRANCH: "360t7" # 或者是 "master"，你修改好代码的那个分支
  # -------------------------------------------------------------------

jobs:
  verify-build:
    name: Verify U-Boot Build
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      # 1. 拉取【另一个仓库】的源码（你已经在里面改好 DTS 了）
      - name: Checkout ImmortalWRT Source from Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          ref: ${{ env.SOURCE_BRANCH }}
          fetch-depth: 1

      # 2. 安装编译依赖（修复 python3-distutils 问题）
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          # 先安装软件源工具，适配不同 Ubuntu 版本
          sudo apt-get install -y software-properties-common
          # 对于 Ubuntu 24.04+，python3-distutils 移到了 python3-setuptools 里
          # 先尝试安装，如果失败则跳过
          sudo apt-get install -y \
            build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev \
            libncurses5-dev libncursesw5-dev libssl-dev \
            python3 python3-setuptools \
            rsync subversion swig time unzip wget xsltproc zlib1g-dev || true
          # 兼容旧版本 Ubuntu，尝试安装 distutils（失败则忽略）
          sudo apt-get install -y python3-distutils || true

      # 3. 配置 ccache
      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-uboot-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-uboot-

      # 4. 更新 Feeds
      - name: Update and Install Feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 5. 配置编译选项
      - name: Configure Firmware
        run: |
          make defconfig
          cat >> .config << 'EOF'
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_honor_fur-602=y
          CONFIG_PACKAGE_uboot-mediatek=y
          EOF
          make olddefconfig

      # 6. 编译验证
      - name: Compile U-Boot (Verify DTS)
        id: compile
        run: |
          export CCACHE_DIR=~/.ccache
          export CCACHE_MAXSIZE=1G
          echo "开始编译 U-Boot..."
          make package/boot/uboot-mediatek/{clean,compile} V=s -j1

      # 7. 上传日志
      - name: Upload Debug Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            .config
            build_dir/target-aarch64_cortex-a53_musl/u-boot-mediatek-*/arch/arm/dts/*.tmp
            build_dir/target-aarch64_cortex-a53_musl/u-boot-mediatek-*/arch/arm/dts/*.dts
            logs/

      - name: Success Message
        if: success()
        run: echo "✅ DTS 语法检查通过！U-Boot 编译成功。"
