name: Check DTS Syntax Only

on:
  workflow_dispatch: # ä»…æ‰‹åŠ¨è§¦å‘

env:
  # --- å·²æ›´æ–°ä¸ºä½ çš„ä»“åº“ä¿¡æ¯ ---
  SOURCE_REPO: "guorong697/immortalwrt"
  SOURCE_BRANCH: "360t7"
  # è¯·æ ¹æ®å®é™…è·¯å¾„ä¿®æ”¹ DTS_FILE_PATHï¼ˆå…³é”®ï¼ï¼‰
  # å…ˆç¡®è®¤ä½ çš„ mt7981_honor-fur-602.dts åœ¨ä»“åº“ä¸­çš„å®é™…ä½ç½®
  DTS_FILE_PATH: "target/linux/mediatek/dts/mt7981b-honor-fur-602.dts"
  # ----------------------------

jobs:
  check-dts:
    name: Validate DTS Syntax
    runs-on: ubuntu-22.04
    timeout-minutes: 10 # ä»…æ£€æŸ¥è¯­æ³•ï¼Œ10åˆ†é’Ÿè¶³å¤Ÿ

    steps:
      # 1. æ‹‰å–ä½ çš„æºç ä»“åº“
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          ref: ${{ env.SOURCE_BRANCH }}
          fetch-depth: 1

      # 2. å®‰è£…è®¾å¤‡æ ‘ç¼–è¯‘å™¨ï¼ˆä»…éœ€è¿™ä¸€ä¸ªå·¥å…·ï¼‰
      - name: Install Device Tree Compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y device-tree-compiler

      # 3. æ ¸å¿ƒæ­¥éª¤ï¼šç›´æ¥ç”¨ dtc æ£€æŸ¥ DTS è¯­æ³•
      - name: Check DTS Syntax with dtc
        run: |
          # æ£€æŸ¥ DTS æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "${{ env.DTS_FILE_PATH }}" ]; then
            echo "âŒ é”™è¯¯ï¼šDTS æ–‡ä»¶ä¸å­˜åœ¨ï¼è·¯å¾„ï¼š${{ env.DTS_FILE_PATH }}"
            echo "ğŸ“‚ è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -la $(dirname ${{ env.DTS_FILE_PATH }})/ # æ˜¾ç¤ºç›®å½•å†…å®¹ï¼Œæ–¹ä¾¿æ’æŸ¥
            exit 1
          fi

          echo "âœ… æ‰¾åˆ° DTS æ–‡ä»¶ï¼Œå¼€å§‹è¯­æ³•æ£€æŸ¥..."
          # ä½¿ç”¨ dtc ç¼–è¯‘ DTS ä¸º DTBï¼ˆä»…æ£€æŸ¥è¯­æ³•ï¼Œä¸ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶ï¼‰
          # -I dts: è¾“å…¥æ ¼å¼ä¸º DTS
          # -O dtb: è¾“å‡ºæ ¼å¼ä¸º DTB
          # -o /dev/null: ä¸ä¿å­˜è¾“å‡ºæ–‡ä»¶
          # -W no-unit_address_vs_reg: å¿½ç•¥éå…³é”®è­¦å‘Š
          dtc -I dts -O dtb -o /dev/null -W no-unit_address_vs_reg ${{ env.DTS_FILE_PATH }}

          echo "ğŸ‰ DTS æ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡ï¼æ²¡æœ‰è¯­æ³•é”™è¯¯ã€‚"

      # 4. å¤±è´¥æ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
      - name: Show Debug Info on Failure
        if: failure()
        run: |
          echo "ğŸ“ DTS æ–‡ä»¶å†…å®¹ï¼ˆå‰200è¡Œï¼‰ï¼š"
          head -200 ${{ env.DTS_FILE_PATH }}
          echo "ğŸ“ æ£€æŸ¥ dtc ç‰ˆæœ¬ï¼š"
          dtc --version
