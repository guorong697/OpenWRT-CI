name: ImmortalWRT Compile Check

on:
  workflow_dispatch: # 仅保留手动触发功能

jobs:
  verify-build:
    name: Verify U-Boot Build
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev \
            libncurses5-dev libncursesw5-dev libssl-dev \
            python3 python3-distutils python3-setuptools \
            rsync subversion swig time unzip wget xsltproc zlib1g-dev

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-uboot-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-uboot-

      - name: Update and Install Feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure Firmware
        run: |
          make defconfig
          cat >> .config << 'EOF'
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_honor_fur-602=y
          CONFIG_PACKAGE_uboot-mediatek=y
          EOF
          make olddefconfig

      - name: Compile U-Boot (Verify DTS)
        id: compile
        run: |
          export CCACHE_DIR=~/.ccache
          export CCACHE_MAXSIZE=1G
          echo "开始编译 U-Boot 以验证 DTS 语法..."
          make package/boot/uboot-mediatek/{clean,compile} V=s -j1

      - name: Upload Debug Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            .config
            build_dir/target-aarch64_cortex-a53_musl/u-boot-mediatek-*/arch/arm/dts/*.tmp
            build_dir/target-aarch64_cortex-a53_musl/u-boot-mediatek-*/arch/arm/dts/*.dts
            logs/

      - name: Success Message
        if: success()
        run: echo "✅ DTS 语法检查通过！U-Boot 编译成功。"
